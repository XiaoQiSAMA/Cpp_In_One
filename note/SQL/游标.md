# 变量
- 系统变量(@@修饰)
	- 分类
		- 全局系统变量
			- 针对所有会话有效
			- 重启失效
		- 会话系统变量(默认)

	- 查看系统变量
		<pre>
		# 查看全部系统变量
		SHOW GLOBAL VARIABLES [LIKE 'xxx']; 	# 查看全局系统变量
		SHOW SESSION VARIABLES [LIKE 'xxx']; 	# 查看会话系统变量
		SHOW VARIABLES;  						# 默认的，会话
		</pre>
	
		<pre>
		# 查看指定系统变量
		SELECT @@global.变量名；	# 查看全局变量
		SELECT @@session.变量名；# 查看会话变量
		SELECT @@变量名；		# 先查会话，后查系统
		</pre>
	
	- 修改系统变量
		<pre>
		# 修改指定系统变量
		SET @@global.变量名 = value；	# 修改全局变量，重启前有效
		SET @@session.变量名 = value；	# 修改会话变量，重连前有效
		SET @@变量名；		# 先查会话，后查系统
		</pre>
		- 持久化的修改需要在配置文件修改

- 用户变量
	- 分类
		- 会话用户变量(@修饰)
			- 仅对当前会话有效
		- 局部变量
			- **需要指定类型**
			- **只在BEGIN和END之间有效**
			- **只能在存储过程和函数中使用**
			- 不能在存储过程的参数列表中使用

	- 定义和使用用户变量
		<pre>
		# 定义会话用户变量
		SET @变量名 = value;
		SET @变量名 := value;
		SELECT @变量名 := 表达式 [FROM ...]
		SELECT 表达式 INTO @变量名 [FROM ...]
		</pre>
		<pre>
		# 定义局部变量(使用DECLARE关键字)
		DECLARE 变量名 类型 [default 值]; 
		# 使用局部变量
		SET 变量名 = value;
		SELECT 值 INTO 变量名; 
		</pre>

# 定义条件与处理程序
- 只能在存储过程或函数中定义错误和定义处理程序
- 定义错误
	<pre>
	DECLARE 错误名称 CONDITION FOR 错误码;
	</pre>
	<pre>
	DECLARE 错误名称 CONDITION FOR SQLSTATE '错误码';
	</pre>
- 定义处理程序
	<pre>
	DECLARE 处理方式 HANDLER FOR 错误类型 处理语句;
	</pre>
	- 处理方式
		- CONTINUE
		- EXIT
		- UNDO
	- 错误类型
		- SQLSTATE '字符串错误码': 匹配5位长度的sqlstate_value类型
		- MySQL_error_code: 数值类型的错误代码
		- 错误名称
		- SQLWARNING
		- NOT FOUND
		- SQLEXCEPTION

- 案例
	<pre>
	DROP PROCEDURE IF EXISTS p_proc;

	DELIMITER $
	
	CREATE PROCEDURE IF NOT EXISTS p_proc()
	BEGIN
		DECLARE CONTINUE HANDLER FOR 1048 SELECT 'error occurs';	
		# 必须首先声明处理程序，才能在错误出现时有处理方式可以用来执行
		
		UPDATE dbtest.employees 
		SET email = NULL
		WHERE last_name = 'Abel';
		
		SELECT 'continue ...';
	END$
	
	DELIMITER ;
	
	CALL p_proc();
	</pre>

# 流程控制
- **流程控制只能在存储过程和函数中出现**
- 流程
	- 顺序结构
	- 分支结构
		- IF
		<pre>
		IF 条件1 THEN 表达式1;
		[ELSEIF 条件2 THEN 表达式2;]
		... 
		[ELSE 表达式3;]
		END IF;
		</pre>

		- CASE
		<pre>
		CASE 变量名
		WHEN 值1 | 范围1 THEN 表达式1;
		WHEN 值2 | 范围2 THEN 表达式2;
		...
		ELSE 语句3
		END CASE;
		</pre>
	- 循环结构
		- LOOP
		<pre>
		[loop_label:] LOOP
			循环体
		END LOOP [loop_label]
		</pre>
		<pre>
		DROP PROCEDURE IF EXISTS p_proc;

		DELIMITER $
		
		CREATE PROCEDURE IF NOT EXISTS p_proc()
		BEGIN
			DECLARE num INT DEFAULT 0;
			loop_label: LOOP
				SET num = num + 1;
				IF num > 10
					THEN LEAVE loop_label;
				END IF;
			END LOOP loop_label;
			
			SELECT num;
		END $
		
		DELIMITER ;
		
		CALL p_proc();
		</pre>
		- WHILE
		<pre>
		[while_label:] WHILE 条件 DO
			循环体;
		END WHILE;
		# 注意DO后没有分号
		</pre>

		- REPEAT
		<pre>
		[repeat_label:] REPEAT
			循环体;
		UNTIL 终止条件
		END REPEAT [repeat_label];
		# 注意终止条件后没有分号
		</pre>
		 
- 流程控制
	- 条件判断语句
	- 循环语句
	- 跳转语句
		- LEAVE 标签名
			- 离开某个循环(即break的作用)
		- ITERATE 标签名
			- 跳转到下一次循环(即continue的作用)

# 游标
- 使用游标
	- 声明游标
		<pre>
		DECLARE cursor_name CURSOR FOR select_statement;
		</pre>
	- 打开游标
		<pre>
		OPEN cursor_name;
		</pre>
	- 使用游标
		<pre>
		FETCH c_cursor INTO v_variable;
		</pre>
	- 关闭游标
		<pre>
		CLOSE cursor_name;
		</pre>

- 示例
	<pre>
	DROP PROCEDURE IF EXISTS p_proc;
	
	DELIMITER $
	
	CREATE PROCEDURE IF NOT EXISTS p_proc()
	BEGIN
		DECLARE sum_salary DOUBLE DEFAULT 0;
		DECLARE emp_salary DOUBLE;
		DECLARE num INT DEFAULT 0;
		
		DECLARE c_cursor CURSOR FOR SELECT salary FROM dbtest.employees;
		OPEN c_cursor;
		
		WHILE sum_salary < 230000 DO
			FETCH c_cursor INTO emp_salary;
			
			SET sum_salary = sum_salary + emp_salary;
			SET num = num + 1;
		END WHILE;
		
		SELECT num, sum_salary;
		CLOSE c_cursor;
	END $
	
	DELIMITER ;
	
	CALL p_proc();
	</pre>